<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>내 소설 보기 - novel</title>
  <style>
    html,body{margin:0;padding:0;height:100%;font-family:sans-serif;background:#ffcc00}
    header{background:#f00;color:#fff;padding:10px 16px;font-size:20px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .h-actions{display:flex;gap:8px}
    button{background:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:700}
    main{display:grid;gap:16px;padding:16px}
    .layout{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.layout{grid-template-columns:340px 1fr}}
    .list{background:#fff;border:1px solid #ddd;border-radius:10px;padding:12px;max-height:70vh;overflow:auto}
    .card{border:1px solid #eee;border-radius:10px;padding:10px;margin-bottom:10px;cursor:pointer;background:#fafafa}
    .card:hover{background:#f3f3f3}
    .card-title{font-weight:700;margin-bottom:4px}
    .card-meta{font-size:12px;color:#555}
    .detail{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px}
    .title-box{border:2px solid #333;padding:10px;margin-bottom:10px;font-weight:bold;font-size:18px;background:#fff}
    .meta{font-size:12px;color:#666;margin-bottom:8px}
    .content-box{border:1px solid #555;padding:12px;white-space:pre-wrap;background:#fff;min-height:240px}
    .empty{color:#333;font-weight:bold;text-align:center;padding:40px;background:#fff;border:1px dashed #aaa;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <span>내 소설 보기</span>
    <div class="h-actions">
      <button onclick="location.href='success.html'">홈으로</button>
      <button onclick="location.href='write.html'">새로 쓰기</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <aside class="list" id="list"></aside>
      <section class="detail" id="detail">
        <div id="titleBox" class="title-box">제목 없음</div>
        <div id="metaBox" class="meta"></div>
        <div id="contentBox" class="content-box">내용 없음</div>
      </section>
    </div>
    <div id="emptyState" class="empty" style="display:none;">
      저장된 소설이 없습니다. <button onclick="location.href='write.html'">지금 쓰기</button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr516GzQlQu6ev5K9GKwlE--6GWjPSjKw",
      authDomain: "novel-app-33aa7.firebaseapp.com",
      projectId: "novel-app-33aa7",
      storageBucket: "novel-app-33aa7.firebasestorage.app",
      messagingSenderId: "791233454587",
      appId: "1:791233454587:web:20319c91ca14d34bdc6b5e",
      measurementId: "G-BXT8Y97XW2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const listEl = document.getElementById('list');
    const titleEl = document.getElementById('titleBox');
    const contentEl = document.getElementById('contentBox');
    const metaEl = document.getElementById('metaBox');
    const detailEl = document.getElementById('detail');
    const emptyEl = document.getElementById('emptyState');

    onAuthStateChanged(auth, async (u)=>{
      if(!u){ alert('로그인이 필요합니다.'); location.href='login.html'; return; }
      loadList(u.uid, u.displayName || '익명');
    });

    async function loadList(uid, displayName){
      listEl.innerHTML = '불러오는 중…';
      try{
        const q = query(collection(db, `users/${uid}/novels`), orderBy('createdAt','desc'));
        const qs = await getDocs(q);

        if(qs.empty){
          detailEl.style.display='none'; emptyEl.style.display=''; listEl.innerHTML=''; return;
        }

        listEl.innerHTML='';
        const params = new URLSearchParams(location.search);
        const wantId = params.get('id');
        let first = null;

        for (const d of qs.docs){
          const n = { id:d.id, ...d.data() };
          const card = document.createElement('div'); card.className='card'; card.onclick=()=>showDetail(n, displayName);
          const t = document.createElement('div'); t.className='card-title'; t.textContent = n.title || '제목 없음';
          const m = document.createElement('div'); m.className='card-meta';
          const dt = n.createdAt?.toDate ? n.createdAt.toDate() : new Date();
          const ts = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
          m.textContent = `${n.author || displayName} · ${ts}`;
          const p = document.createElement('div'); p.style.fontSize='12px'; p.style.color='#333'; p.textContent=(n.content||'').slice(0,60)+((n.content||'').length>60?'…':'');
          card.appendChild(t); card.appendChild(m); card.appendChild(p); listEl.appendChild(card);

          if(!first) first = n;
          if(wantId && n.id === wantId) first = n;
        }

        if (wantId && !first?.id){
          // URL로 바로 특정 문서 열기 (목록에 없을 때 대비)
          const snap = await getDoc(doc(db, `users/${uid}/novels/${wantId}`));
          if (snap.exists()) first = { id:snap.id, ...snap.data() };
        }
        if(first) showDetail(first, displayName);
      }catch(e){
        alert('불러오기 실패: ' + e.message);
      }
    }

    function showDetail(n, displayName){
      titleEl.textContent = n.title || '제목 없음';
      contentEl.textContent = n.content || '내용 없음';
      const dt = n.createdAt?.toDate ? n.createdAt.toDate() : new Date();
      const ts = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      metaEl.textContent = `${n.author || displayName} · ${ts}`;
    }
  </script>
</body>
</html>

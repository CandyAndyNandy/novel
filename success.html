<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Success - NOVEL</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    /* 상단 영역: 빨강+노랑 */
    .top-bar {
      display: flex;
      height: 20vh; /* 20% 빨강 */
    }
    .red-section {
      flex: 2; /* 20% */
      background-color: red;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      padding: 10px;
      color: white;
    }
    .yellow-section {
      flex: 8; /* 80% */
      background-color: yellow;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      font-weight: bold;
    }
    /* 버튼 스타일 */
    .button-bar {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-bar button {
      background: white;
      color: black;
      border: 1px solid black;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .button-bar button:hover {
      background: #f2f2f2;
    }
    /* 콘텐츠 영역 */
    .content {
      padding: 20px;
    }
    .feed-button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      border: 1px solid #333;
      background: white;
      cursor: pointer;
      text-align: left;
    }
    .feed-button:hover {
      background: #eee;
    }
  </style>
</head>
<body>
  <!-- 상단 영역 -->
  <div class="top-bar">
    <div class="red-section">
      <div class="button-bar">
        <button onclick="location.href='write.html'">소설쓰기</button>
        <button onclick="location.href='view.html'">내 소설 보기</button>
        <button onclick="logout()">로그아웃</button>
        <button onclick="deleteAccount()">회원탈퇴</button>
      </div>
    </div>
    <div class="yellow-section">
      NOVEL
    </div>
  </div>

  <!-- 공개 피드 + 시리즈 -->
  <div class="content">
    <h2>공개 피드</h2>
    <div id="feedStatus"></div>
    <div id="feedContainer"></div>

    <h2 style="margin-top:30px;">시리즈(묶음)</h2>
    <div id="bundleBox">불러오는 중…</div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ✅ Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCr516GzQlQu6ev5K9GKwlE--6GWjPSjKw",
      authDomain: "novel-app-33aa7.firebaseapp.com",
      projectId: "novel-app-33aa7",
      storageBucket: "novel-app-33aa7.firebasestorage.app",
      messagingSenderId: "791233454587",
      appId: "1:791233454587:web:20319c91ca14d34bdc6b5e",
      measurementId: "G-BXT8Y97XW2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 로그아웃
    window.logout = async function() {
      await signOut(auth);
      alert("로그아웃 되었습니다.");
      location.href = "index.html";
    }

    // 회원탈퇴
    window.deleteAccount = async function() {
      if(confirm("정말로 회원 탈퇴하시겠습니까?")){
        const user = auth.currentUser;
        if(user){
          try {
            await deleteUser(user);
            alert("회원 탈퇴가 완료되었습니다.");
            location.href = "index.html";
          } catch(e){
            alert("회원 탈퇴 실패: " + e.message);
          }
        }
      }
    }

    // 공개 피드 불러오기
    const feed = document.getElementById("feedContainer");
    const status = document.getElementById("feedStatus");

    async function loadFeed(){
      feed.innerHTML = ""; status.textContent = "불러오는 중…";
      try{
        const q = query(collection(db, "public_novels"), orderBy("createdAt","desc"));
        const snap = await getDocs(q);
        status.textContent = snap.empty ? "아직 공개된 소설이 없습니다." : "";
        snap.forEach(d=>{
          const v = d.data();
          const btn = document.createElement("button");
          btn.className = "feed-button";
          const series = v.seriesName ? ` (시리즈: ${v.seriesName})` : "";
          btn.textContent = `${v.title || "(제목 없음)"} - ${v.author || "익명"}${series}`;
          btn.onclick = ()=> location.href = `detail.html?id=${d.id}`;
          feed.appendChild(btn);
        });
      }catch(e){ status.textContent = "불러오기 실패: " + e.message; }
    }
    loadFeed();

    // ✅ 시리즈(묶음) 불러오기
    const bundleBox = document.getElementById("bundleBox");
    async function loadBundles(){
      bundleBox.innerHTML = "불러오는 중…";
      try{
        const q = query(collection(db,'bundles'), orderBy('createdAt','desc'));
        const s = await getDocs(q);
        if (s.empty){ bundleBox.textContent = '등록된 시리즈가 없습니다.'; return; }
        bundleBox.innerHTML = "";
        s.forEach(d=>{
          const v = d.data();
          const b = document.createElement('button');
          b.className = 'feed-button';
          b.textContent = v.name || '시리즈';
          b.onclick = ()=> location.href = `bundle_detail.html?id=${d.id}`;
          bundleBox.appendChild(b);
        });
      }catch(e){
        bundleBox.textContent = "시리즈 불러오기 실패: " + e.message;
      }
    }
    loadBundles();
  </script>
</body>
</html>

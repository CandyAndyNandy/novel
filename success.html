<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>novel</title>
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif}
    .top{background:#f00;height:20vh;position:relative;color:#fff;font-weight:700;font-size:32px}
    .top-content{position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center}
    .top-buttons{position:absolute;left:20px;top:40%;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px}
    .top-buttons .btn{background:#fff;color:#000;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:700}
    .account{position:absolute;right:16px;top:10px;display:flex;gap:8px}
    .account .btn{background:#fff;color:#000;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-weight:700}
    .bottom{background:#ffcc00;height:80vh;display:flex;justify-content:center;align-items:center;font-size:22px;font-weight:700;color:#333}
    .wave{position:absolute;bottom:-1px;left:0;width:100%;height:100px} svg{display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <div class="top">
    <div class="top-content">
      <div class="top-buttons">
        <button class="btn" onclick="location.href='write.html'">소설 쓰기</button>
        <button class="btn" onclick="location.href='view.html'">내 소설 보기</button>
        <button class="btn" onclick="location.href='tls123.html'">회원 목록(Admin)</button>
      </div>
      NOVEL
      <div class="account">
        <button class="btn" id="logoutBtn">로그아웃</button>
        <button class="btn" id="deleteBtn">회원탈퇴</button>
      </div>
    </div>
    <div class="wave"><svg viewBox="0 0 1440 320" preserveAspectRatio="none"><path fill="#ffcc00" d="M0,64L80,85.3C160,107,320,149,480,165.3C640,181,800,171,960,181.3C1120,192,1280,224,1360,240L1440,256V320H0Z"></path></svg></div>
  </div>
  <div class="bottom" id="welcome">환영합니다!</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr516GzQlQu6ev5K9GKwlE--6GWjPSjKw",
      authDomain: "novel-app-33aa7.firebaseapp.com",
      projectId: "novel-app-33aa7",
      storageBucket: "novel-app-33aa7.firebasestorage.app",
      messagingSenderId: "791233454587",
      appId: "1:791233454587:web:20319c91ca14d34bdc6b5e",
      measurementId: "G-BXT8Y97XW2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    onAuthStateChanged(auth, (u)=>{
      if(!u){ alert('로그인이 필요합니다.'); location.href='login.html'; return; }
      document.getElementById('welcome').textContent = `환영합니다, ${u.displayName || '익명'}님!`;
    });

    document.getElementById('logoutBtn').onclick = async ()=> {
      await signOut(auth);
      location.href = 'index.html';
    };

    // 탈퇴: 재인증(비밀번호 물음) → novels 하위문서 삭제 → users/{uid} 삭제 → nicknames/{nick} 삭제 → 계정 삭제
    document.getElementById('deleteBtn').onclick = async ()=> {
      const u = auth.currentUser;
      if (!u) return alert('로그인이 필요합니다.');

      const nickLower = (u.displayName || '').toLowerCase();
      const pass = prompt('본인 확인을 위해 비밀번호를 다시 입력하세요.');
      if (!pass) return;

      try {
        const credential = EmailAuthProvider.credential(`${nickLower}@novel.local`, pass);
        await reauthenticateWithCredential(u, credential);

        // 1) 내 소설 모두 삭제
        const novelsSnap = await getDocs(collection(db, `users/${u.uid}/novels`));
        for (const d of novelsSnap.docs) await deleteDoc(d.ref);

        // 2) 내 프로필 문서 삭제
        await deleteDoc(doc(db, `users/${u.uid}`));

        // 3) 닉네임 예약 문서 삭제(있으면)
        try { await deleteDoc(doc(db, `nicknames/${nickLower}`)); } catch(_) {}

        // 4) 계정 삭제
        await deleteUser(u);

        alert('회원탈퇴가 완료되었습니다.');
        location.href = 'index.html';
      } catch (e) {
        alert('탈퇴 실패: ' + e.message);
      }
    };
  </script>
</body>
</html>
